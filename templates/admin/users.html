<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Manage Users</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Manage Users</h2>
        <a href="/admin" class="btn btn-primary">Back to Dashboard</a>
    </div>

    <!-- Add/Edit User Form -->
    <form method="POST" class="mb-4">
        <input type="hidden" name="user_id" id="user_id">

        <div class="row mb-3">
            <div class="col">
                <label class="form-label">Emp ID</label>
                <input type="text" name="emp_id" id="emp_id" class="form-control" required>
            </div>
            <div class="col">
                <label class="form-label">Name</label>
                <input type="text" name="name" id="name" class="form-control" required>
            </div>
            <div class="col">
                <label class="form-label">Email</label>
                <input type="email" name="email" id="email" class="form-control" required>
            </div>
            <div class="col">
                <label class="form-label">Password</label>
                <input type="password" name="password" id="password" class="form-control">
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Access Permissions</label>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="selectAll">
                <label class="form-check-label" for="selectAll"><strong>Select All</strong></label>
            </div>
            {% set modules = ['banners',
            'doctors',
            'counters',
            'testimonials',
            'specialities',
            'departments',
            'health_packages',
            'sports_packages',
            'department_content',
            'users',
            'callback_requests',
            'reviews'] %}

            {% for module in modules %}
            <div class="form-check form-check-inline">
                <input type="checkbox" class="form-check-input access-checkbox" id="{{module}}" name="{{module}}">
                <label class="form-check-label" for="{{module}}">{{ module.replace('_',' ').title() }}</label>
            </div>
            {% endfor %}
        </div>

        <div class="form-check mb-3">
            <input type="checkbox" class="form-check-input" id="is_active" name="is_active" checked>
            <label class="form-check-label" for="is_active">Active</label>
        </div>

        <button type="submit" class="btn btn-primary">Save User</button>
    </form>

    <!-- Users Table -->
    <h3>Existing Users</h3>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Emp ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Access</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.emp_id }}</td>
                <td>{{ user.name }}</td>
                <td>{{ user.email }}</td>
                <td>
                    {% if user.access %}
                    {% for module in modules %}
                    {% if user.access[module] %}
                    <span class="badge bg-success">{{ module.replace('_',' ').title() }}</span>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                </td>
                <td>{{ 'Active' if user.is_active else 'Inactive' }}</td>
                <td>
                    <button class="btn btn-sm btn-warning"
                        onclick='editUser({{ user.id }}, {{ user.emp_id|tojson }}, {{ user.name|tojson }}, {{ user.email|tojson }}, {{ "true" if user.is_active else "false" }}, {{ user.access|tojson }})'>Edit</button>
                    <form method="POST" action="{{ url_for('delete_user', user_id=user.id) }}" style="display:inline;"
                        onsubmit="return confirmDelete();">
                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                    </form>

                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        function editUser(id, emp_id, name, email, is_active, access) {
            document.getElementById('user_id').value = id;
            document.getElementById('emp_id').value = emp_id;
            document.getElementById('name').value = name;
            document.getElementById('email').value = email;
            document.getElementById('password').value = "";

            document.getElementById('is_active').checked = is_active;

            const checkboxes = document.querySelectorAll('.access-checkbox');
            checkboxes.forEach(cb => {
                if (access && access.hasOwnProperty(cb.id)) {
                    cb.checked = access[cb.id];
                } else {
                    cb.checked = false;
                }
            });

            // Scroll to top so form is visible
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Select/Deselect all checkboxes
        document.getElementById('selectAll').addEventListener('change', function () {
            const checked = this.checked;
            document.querySelectorAll('.access-checkbox').forEach(cb => cb.checked = checked);
        });

        // Confirm delete
        function confirmDelete() {
            return confirm("Are you sure you want to delete this user?");
        }
    </script>

</body>

</html>