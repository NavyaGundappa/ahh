{% extends "admin_layout.html" %}

{% block title %}
Department Services Management - Admin Panel
{% endblock %}

{% block content %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<h2 class="mb-4 text-2xl font-bold">Department Services</h2>
<div class="flex justify-end mb-3 space-x-2">
  <a href="{{ url_for('admin_dashboard') }}"
    class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition">
    Back to Dashboard
  </a>
  <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition"
    onclick="openServiceModal()">
    <i class="fas fa-plus me-1"></i> Add New Service
  </button>
</div>

<div id="serviceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
    <div class="mt-3 text-left">
      <h3 class="text-lg leading-6 font-medium text-gray-900" id="serviceModalLabel">Add Department Service</h3>
      <div class="mt-2 px-7 py-3">
        <form method="POST" action="{{ url_for('admin_department_services') }}" enctype="multipart/form-data"
          id="serviceForm">
          <input type="hidden" name="service_id" id="serviceId" value="">
          <div class="mb-4">
            <label for="service_department_id" class="block text-gray-700 text-sm font-bold mb-2">Department</label>
            <select class="w-full px-3 py-2 border rounded shadow-sm" id="service_department_id" name="department_id"
              required>
              <option value="">Select Department</option>
              {% for department in departments %}
              <option value="{{ department.id }}">{{ department.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-4">
            <label for="title" class="block text-gray-700 text-sm font-bold mb-2">Service Title</label>
            <input type="text" class="w-full px-3 py-2 border rounded shadow-sm" id="title" name="title" required>
          </div>
          <div class="md:col-span-2 mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2">Description</label>
            <div id="department-description-editor" style="min-height: 150px;"></div>
            <input type="hidden" name="description" id="department-description-input">
          </div>
          <div class="mb-4">
            <label for="list_items" class="block text-gray-700 text-sm font-bold mb-2">List Items (comma
              separated)</label>
            <textarea class="w-full px-3 py-2 border rounded shadow-sm" id="list_items" name="list_items" rows="3"
              placeholder="Item 1, Item 2, Item 3"></textarea>
          </div>
          <div class="mb-4">
            <label for="services_overview" class="block text-gray-700 text-sm font-bold mb-2">Services Section
              Overview</label>
            <textarea class="w-full px-3 py-2 border rounded shadow-sm" id="services_overview" name="services_overview"
              rows="6" placeholder="Add overview content that will appear above the services list..."></textarea>
            <p class="text-sm text-gray-500 mt-1">This overview content will appear above all services on the department
              page</p>
          </div>
          <div class="mb-4">
            <label for="icon" class="block text-gray-700 text-sm font-bold mb-2">Service Icon</label>
            <input type="file" class="w-full px-3 py-2 border rounded shadow-sm" id="icon" name="icon" accept="image/*">
            <p class="text-sm text-gray-500 mt-1">Upload an icon image for this service</p>
            <div id="iconPreview" class="mt-2"></div>
          </div>
          <div class="flex items-center justify-end mt-4">
            <button type="button"
              class="bg-gray-500 text-white px-4 py-2 rounded font-bold hover:bg-gray-700 transition"
              onclick="closeModal('serviceModal')">Cancel</button>
            <button type="submit"
              class="bg-blue-500 text-white px-4 py-2 rounded font-bold hover:bg-blue-700 transition ml-2">Save
              Service</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="bg-white p-6 rounded shadow-md">
  <div class="mb-3">
    <input type="text" id="departmentSearch"
      class="w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
      placeholder="Search by Department (starting letters)...">
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full leading-normal" id="servicesTable">
      <thead>
        <tr>
          <th
            class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
            ID</th>
          <th
            class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
            Department</th>
          <th
            class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
            Title</th>
          <th
            class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
            Icon</th>
          <th
            class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
            Services Overview</th>
          <th
            class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
            Last Updated</th>
          <th
            class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
            Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for service in services %}
        <tr class="hover:bg-gray-100 transition duration-150 ease-in-out">
          <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">{{ service.id }}</td>
          <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
            {% for department in departments %}
            {% if department.id == service.department_id %}
            {{ department.name }}
            {% endif %}
            {% endfor %}
          </td>
          <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">{{ service.title }}</td>
          <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
            {% if service.icon_path %}
            <img src="{{ url_for('static', filename=service.icon_path) }}" class="w-12 h-12 object-contain"
              alt="Service Icon">
            {% else %}
            <span class="text-gray-500">No icon</span>
            {% endif %}
          </td>
          <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
            {% if service.services_overview %}
            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">âœ“ Has Overview</span>
            {% else %}
            <span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded-full">No Overview</span>
            {% endif %}
          </td>
          <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">{{ service.updated_at.strftime('%Y-%m-%d
            %H:%M') }}</td>
          <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm space-x-2">
            <button type="button"
              class="edit-service-btn bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-700 transition"
              data-id="{{ service.id }}" data-title="{{ service.title }}"
              data-description="{{ service.description | safe }}" data-list-items="{{ service.list_items }}"
              data-services-overview="{{ service.services_overview }}" data-department-id="{{ service.department_id }}"
              data-icon-path="{{ service.icon_path }}">
              Edit
            </button>
            <form action="{{ url_for('delete_service', id=service.id) }}" method="POST" class="inline">
              <button type="submit" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded text-xs"
                onclick="return confirm('Are you sure you want to delete this service?')">
                <i class="fas fa-trash mr-1"></i> Delete
              </button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
  // ===============================================
  // 1. QUILL RICH TEXT EDITOR INITIALIZATION
  // ===============================================

  // Check if the editor container exists before initializing Quill
  const editorContainer = document.getElementById('department-description-editor');
  let descriptionEditor = null;

  if (editorContainer) {
    descriptionEditor = new Quill('#department-description-editor', {
      theme: 'snow',
      placeholder: 'Enter the service description...',
      modules: {
        toolbar: [
          // Add 'link' to the toolbar to enable hyperlinks
          [{ 'header': [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],        // toggled buttons
          [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
          [{ 'align': [] }],
          [{ 'list': 'ordered' }, { 'list': 'bullet' }],
          ['blockquote', 'code-block'],
          ['link', 'image'],                                // link and image, video
          ['clean']                                         // remove formatting button
        ]
      }
    });
  }


  // ===============================================
  // 2. FORM SUBMISSION HANDLER (Saves Quill content to hidden input)
  // ===============================================

  // Find the main form for Add/Edit
  const form = document.getElementById('serviceForm');
  const hiddenInput = document.getElementById('department-description-input');

  if (form && hiddenInput && descriptionEditor) {
    form.addEventListener('submit', function (event) {
      // Get the HTML content from the Quill editor
      const htmlContent = descriptionEditor.root.innerHTML;
      // Set it as the value of the hidden input field
      hiddenInput.value = htmlContent;
    });
  }


  // ===============================================
  // 3. SERVICE MODAL FUNCTIONS
  // ===============================================

  function openServiceModal() {
    document.getElementById('serviceModalLabel').textContent = 'Add Department Service';
    document.getElementById('serviceId').value = '';
    document.getElementById('service_department_id').value = '';
    document.getElementById('title').value = '';
    // Clear the Quill editor content for a new entry
    if (descriptionEditor) {
      descriptionEditor.root.innerHTML = '';
    }
    document.getElementById('list_items').value = '';
    document.getElementById('services_overview').value = '';
    document.getElementById('icon').value = '';
    document.getElementById('iconPreview').innerHTML = '';
    document.getElementById('serviceModal').classList.remove('hidden');
  }

  function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
  }

  // Edit functionality for services
  document.querySelectorAll('.edit-service-btn').forEach(button => {
    button.addEventListener('click', function () {
      const serviceId = this.getAttribute('data-id');
      const title = this.getAttribute('data-title');
      const description = this.getAttribute('data-description');
      const listItems = this.getAttribute('data-list-items');
      const departmentId = this.getAttribute('data-department-id');
      const iconPath = this.getAttribute('data-icon-path');
      const servicesOverview = this.getAttribute('data-services-overview');

      document.getElementById('serviceId').value = serviceId;
      document.getElementById('title').value = title;
      document.getElementById('list_items').value = listItems;
      document.getElementById('services_overview').value = servicesOverview;
      document.getElementById('service_department_id').value = departmentId;

      // Set Quill editor content with the existing description
      if (descriptionEditor && description) {
        descriptionEditor.root.innerHTML = description;
      }

      if (iconPath && iconPath !== "None") {
        document.getElementById('iconPreview').innerHTML =
          `<img src="{{ url_for('static', filename='') }}${iconPath}" class="w-12 h-12 object-contain" alt="Current icon">`;
      } else {
        document.getElementById('iconPreview').innerHTML = '';
      }

      document.getElementById('serviceModalLabel').textContent = 'Edit Department Service';
      document.getElementById('serviceModal').classList.remove('hidden');
    });
  });

  // Department search filter (starting letters)
  document.getElementById("departmentSearch").addEventListener("keyup", function () {
    const input = this.value.toLowerCase();
    const rows = document.querySelectorAll("#servicesTable tbody tr");

    rows.forEach(row => {
      const departmentCell = row.cells[1];
      if (departmentCell) {
        const text = departmentCell.textContent.trim().toLowerCase();
        // Filter by starting letters or show all if input is empty
        if (text.startsWith(input) || input === "") {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      }
    });
  });

  // Icon preview when selecting a new file
  document.getElementById('icon').addEventListener('change', function (event) {
    const file = event.target.files[0];
    const preview = document.getElementById('iconPreview');

    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        preview.innerHTML = `<img src="${e.target.result}" class="w-12 h-12 object-contain" alt="Preview">`;
      };
      reader.readAsDataURL(file);
    } else {
      preview.innerHTML = '';
    }
  });

</script>
{% endblock %}