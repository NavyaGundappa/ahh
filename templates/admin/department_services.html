<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Department Services Management</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .preview-icon {
      max-width: 50px;
      max-height: 50px;
    }
  </style>
</head>

<body>
  <div class="container-fluid py-4">
    <!-- Flash Messages -->


    <!-- Department Services Section -->
    <div class="card">
      <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <h3 class="mb-0">Department Services</h3>
        <div class="d-flex justify-content-end mb-3">
          <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary me-2">
            Back to Dashboard
          </a>
          <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#serviceModal">
            <i class="fas fa-plus me-1"></i> Add New Service
          </button>
        </div>
      </div>
      <div class="card-body">

        <!-- Department Search -->
        <div class="mb-3">
          <input type="text" id="departmentSearch" class="form-control"
            placeholder="Search by Department (starting letters)...">
        </div>

        <div class="table-responsive">
          <table class="table table-striped table-hover" id="servicesTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Department</th>
                <th>Title</th>
                <th>Icon</th>
                <th>Description Preview</th>
                <th>Last Updated</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for service in services %}
              <tr>
                <td>{{ service.id }}</td>
                <td>
                  {% for department in departments %}
                  {% if department.id == service.department_id %}
                  {{ department.name }}
                  {% endif %}
                  {% endfor %}
                </td>
                <td>{{ service.title }}</td>
                <td>
                  {% if service.icon_path %}
                  <img src="{{ url_for('static', filename=service.icon_path) }}" class="preview-icon"
                    alt="Service Icon">
                  {% else %}
                  <span class="text-muted">No icon</span>
                  {% endif %}
                </td>
                <td>{{ service.description[:50] }}{% if service.description|length > 50 %}...{% endif %}</td>
                <td>{{ service.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                  <button class="btn btn-sm btn-warning edit-service" data-id="{{ service.id }}"
                    data-title="{{ service.title }}" data-description="{{ service.description }}"
                    data-list-items="{{ service.list_items }}" data-department-id="{{ service.department_id }}"
                    data-icon-path="{{ service.icon_path }}">
                    <i class="fas fa-edit"></i>
                  </button>
                  <form action="{{ url_for('delete_service', id=service.id) }}" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-sm btn-danger"
                      onclick="return confirm('Are you sure you want to delete this service?')">
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Service Modal -->
    <div class="modal fade" id="serviceModal" tabindex="-1" aria-labelledby="serviceModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <form method="POST" action="{{ url_for('admin_department_services') }}" enctype="multipart/form-data">
            <input type="hidden" name="service_id" id="serviceId" value="">
            <div class="modal-header">
              <h5 class="modal-title" id="serviceModalLabel">Add Department Service</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="service_department_id" class="form-label">Department</label>
                <select class="form-select" id="service_department_id" name="department_id" required>
                  <option value="">Select Department</option>
                  {% for department in departments %}
                  <option value="{{ department.id }}">{{ department.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label for="title" class="form-label">Service Title</label>
                <input type="text" class="form-control" id="title" name="title" required>
              </div>
              <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="4"></textarea>
              </div>
              <div class="mb-3">
                <label for="list_items" class="form-label">List Items (comma separated)</label>
                <textarea class="form-control" id="list_items" name="list_items" rows="3"
                  placeholder="Item 1, Item 2, Item 3"></textarea>
              </div>
              <div class="mb-3">
                <label for="icon" class="form-label">Service Icon</label>
                <input type="file" class="form-control" id="icon" name="icon" accept="image/*">
                <div class="form-text">Upload an icon image for this service</div>
                <div id="iconPreview" class="mt-2"></div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Save Service</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Service form handling
    document.querySelectorAll('.edit-service').forEach(button => {
      button.addEventListener('click', function () {
        const serviceId = this.getAttribute('data-id');
        const title = this.getAttribute('data-title');
        const description = this.getAttribute('data-description');
        const listItems = this.getAttribute('data-list-items');
        const departmentId = this.getAttribute('data-department-id');
        const iconPath = this.getAttribute('data-icon-path');

        document.getElementById('serviceId').value = serviceId;
        document.getElementById('title').value = title;
        document.getElementById('description').value = description;
        document.getElementById('list_items').value = listItems;
        document.getElementById('service_department_id').value = departmentId;

        if (iconPath) {
          document.getElementById('iconPreview').innerHTML =
            `<img src="${iconPath}" class="preview-icon" alt="Current icon">`;
        }

        document.getElementById('serviceModalLabel').textContent = 'Edit Department Service';

        const serviceModal = new bootstrap.Modal(document.getElementById('serviceModal'));
        serviceModal.show();
      });
    });

    // Reset form when modal is closed
    document.getElementById('serviceModal').addEventListener('hidden.bs.modal', function () {
      document.getElementById('serviceId').value = '';
      document.getElementById('iconPreview').innerHTML = '';
      document.getElementById('serviceModalLabel').textContent = 'Add Department Service';
    });

    // Icon preview
    document.getElementById('icon').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById('iconPreview').innerHTML =
            `<img src="${e.target.result}" class="preview-icon" alt="Icon preview">`;
        };
        reader.readAsDataURL(file);
      }
    });

    // Department search filter (starting letters)
    document.getElementById("departmentSearch").addEventListener("keyup", function () {
      const input = this.value.toLowerCase();
      const rows = document.querySelectorAll("#servicesTable tbody tr");

      rows.forEach(row => {
        const departmentCell = row.cells[1]; // Department column
        if (departmentCell) {
          const text = departmentCell.textContent.trim().toLowerCase();
          if (text.startsWith(input) || input === "") {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        }
      });
    });
  </script>
</body>

</html>