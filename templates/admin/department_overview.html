{% extends "admin_layout.html" %}

{% block title %}
Department Overview Management - Admin Panel
{% endblock %}

{% block content %}
<h2 class="mb-4 text-2xl font-bold">Department Overviews</h2>
<div class="flex justify-end mb-3 space-x-2">
    <a href="{{ url_for('admin_dashboard') }}"
        class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition">
        Back to Dashboard
    </a>
    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition"
        onclick="openOverviewModal()">
        <i class="fas fa-plus me-1"></i> Add New Overview
    </button>
</div>

<div id="overviewModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
        <div class="mt-3 text-left">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="overviewModalLabel">Add Department Overview</h3>
            <div class="mt-2 px-7 py-3">
                <form method="POST" action="{{ url_for('admin_department_overview') }}" id="overviewForm">
                    <input type="hidden" name="overview_id" id="overviewId" value="">
                    <div class="mb-4">
                        <label for="department_id" class="block text-gray-700 text-sm font-bold mb-2">Department</label>
                        <select class="w-full px-3 py-2 border rounded shadow-sm" id="department_id"
                            name="department_id" required>
                            <option value="">Select Department</option>
                            {% for department in departments %}
                            <option value="{{ department.id }}">{{ department.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="content" class="block text-gray-700 text-sm font-bold mb-2">Content</label>
                        <textarea class="w-full px-3 py-2 border rounded shadow-sm" id="content" name="content" rows="5"
                            required></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="quote" class="block text-gray-700 text-sm font-bold mb-2">Quote (Optional)</label>
                        <textarea class="w-full px-3 py-2 border rounded shadow-sm" id="quote" name="quote"
                            rows="3"></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="quote_author" class="block text-gray-700 text-sm font-bold mb-2">Quote Author
                            (Optional)</label>
                        <input type="text" class="w-full px-3 py-2 border rounded shadow-sm" id="quote_author"
                            name="quote_author">
                    </div>
                    <div class="flex items-center justify-end mt-4">
                        <button type="button"
                            class="bg-gray-500 text-white px-4 py-2 rounded font-bold hover:bg-gray-700 transition"
                            onclick="closeModal('overviewModal')">Cancel</button>
                        <button type="submit"
                            class="bg-blue-500 text-white px-4 py-2 rounded font-bold hover:bg-blue-700 transition ml-2">Save
                            Overview</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="bg-white p-6 rounded shadow-md">
    <div class="mb-3">
        <input type="text" id="searchInput"
            class="w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Search Department, Content, or Quote...">
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full leading-normal" id="overviewTable">
            <thead>
                <tr>
                    <th
                        class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        ID</th>
                    <th
                        class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Department</th>
                    <th
                        class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Content Preview</th>
                    <th
                        class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Quote</th>
                    <th
                        class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Last Updated</th>
                    <th
                        class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for overview in overviews %}
                <tr class="hover:bg-gray-100 transition duration-150 ease-in-out">
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">{{ overview.id }}</td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                        {% for department in departments %}
                        {% if department.id == overview.department_id %}
                        {{ department.name }}
                        {% endif %}
                        {% endfor %}
                    </td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">{{ overview.content[:50] }}{% if
                        overview.content|length > 50 %}...{% endif %}</td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">{{ overview.quote[:30] }}{% if
                        overview.quote|length > 30 %}...{% endif %}</td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">{{
                        overview.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm space-x-2">
                        <button
                            class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded text-xs edit-overview-btn"
                            data-id="{{ overview.id }}" data-content="{{ overview.content }}"
                            data-quote="{{ overview.quote }}" data-quote-author="{{ overview.quote_author }}"
                            data-department-id="{{ overview.department_id }}">
                            <i class="fas fa-edit mr-1"></i> Edit
                        </button>
                        <form action="{{ url_for('delete_overview', id=overview.id) }}" method="POST" class="inline">
                            <button type="submit"
                                class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded text-xs"
                                onclick="return confirm('Are you sure you want to delete this overview?')">
                                <i class="fas fa-trash mr-1"></i> Delete
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function openOverviewModal() {
        document.getElementById('overviewModalLabel').textContent = 'Add Department Overview';
        document.getElementById('overviewId').value = '';
        document.getElementById('department_id').value = '';
        document.getElementById('content').value = '';
        document.getElementById('quote').value = '';
        document.getElementById('quote_author').value = '';
        document.getElementById('overviewModal').classList.remove('hidden');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
    }

    // Edit functionality
    document.querySelectorAll('.edit-overview-btn').forEach(button => {
        button.addEventListener('click', function () {
            const overviewId = this.getAttribute('data-id');
            const content = this.getAttribute('data-content');
            const quote = this.getAttribute('data-quote');
            const quoteAuthor = this.getAttribute('data-quote-author');
            const departmentId = this.getAttribute('data-department-id');

            document.getElementById('overviewId').value = overviewId;
            document.getElementById('content').value = content;
            document.getElementById('quote').value = quote;
            document.getElementById('quote_author').value = quoteAuthor;
            document.getElementById('department_id').value = departmentId;

            document.getElementById('overviewModalLabel').textContent = 'Edit Department Overview';
            document.getElementById('overviewModal').classList.remove('hidden');
        });
    });

    // Search functionality
    document.getElementById('searchInput').addEventListener('keyup', function () {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll('#overviewTable tbody tr');
        rows.forEach(row => {
            const department = row.cells[1].textContent.toLowerCase();
            const content = row.cells[2].textContent.toLowerCase();
            const quote = row.cells[3].textContent.toLowerCase();
            if (department.includes(filter) || content.includes(filter) || quote.includes(filter)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}