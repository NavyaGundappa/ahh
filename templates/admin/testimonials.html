{% extends "admin_layout.html" %}

{% block title %}
Manage Testimonials - Admin Panel
{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-bold">Manage Testimonials</h2>
    <a href="{{ url_for('admin_dashboard') }}"
        class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition">
        Back to Dashboard
    </a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-1">
        <form method="POST" enctype="multipart/form-data" class="bg-white p-6 rounded shadow-md">
            <h3 class="font-semibold text-lg mb-4">Add New Testimonial</h3>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Patient Name <span
                        class="text-red-500">*</span></label>
                <input type="text" name="patient_name"
                    class="w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="e.g., Sarath KB" required>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Content / Review <span
                        class="text-red-500">*</span></label>
                <textarea name="content" rows="5"
                    class="w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Write the patient's review here..." required></textarea>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">YouTube Video URL (Optional)</label>
                <input type="text" name="youtube_link"
                    class="w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="e.g., https://www.youtube.com/watch?v=...">
                <p class="text-xs text-gray-500 mt-1">Paste the full YouTube video link here.</p>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Primary Doctor (Mandatory) <span
                        class="text-red-500">*</span></label>
                <select name="doctor1_id"
                    class="w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required>
                    <option value="" disabled selected>-- Select a Doctor --</option>
                    {% for doctor in doctors %}
                    <option value="{{ doctor.id }}">{{ doctor.name }} - {{ doctor.specialization }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Secondary Doctor (Optional)</label>
                <select name="doctor2_id"
                    class="w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- None --</option>
                    {% for doctor in doctors %}
                    <option value="{{ doctor.id }}">{{ doctor.name }} - {{ doctor.specialization }}</option>
                    {% endfor %}
                </select>
            </div>

            <button type="submit"
                class="w-full bg-blue-500 text-white px-4 py-2 rounded font-bold hover:bg-blue-700 transition">
                Add Testimonial
            </button>
        </form>
    </div>

    <div class="lg:col-span-2">
        <h3 class="mb-3 text-lg font-bold">Existing Testimonials</h3>
        <div class="bg-white rounded shadow-md">
            <ul class="divide-y divide-gray-200">
                {% for testimonial in testimonials %}
                <li class="p-4 flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <div>
                            <span class="font-medium text-gray-900">{{ testimonial.patient_name }}</span>
                            <p class="text-sm text-gray-600 truncate" style="max-width: 300px;">{{ testimonial.content
                                }}</p>
                            {% if testimonial.doctor %}
                            <p class="text-xs text-blue-600"><b>Primary:</b> {{ testimonial.doctor.name }}</p>
                            {% endif %}
                            {% if testimonial.doctor2 %}
                            <p class="text-xs text-indigo-600"><b>Secondary:</b> {{ testimonial.doctor2.name }}</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex-shrink-0 space-x-2">
                        <button class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-3 rounded text-xs"
                            onclick="openModal('editModal-{{ testimonial.id }}')">Edit</button>
                        <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-3 rounded text-xs"
                            onclick="openModal('deleteModal-{{ testimonial.id }}')">Delete</button>
                    </div>
                </li>
                {% else %}
                <li class="p-4 text-center text-gray-500">
                    No testimonials yet.
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

{% for testimonial in testimonials %}
<div id="deleteModal-{{ testimonial.id }}"
    class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Delete Testimonial</h3>
            <p class="text-sm text-gray-500 mt-2">Are you sure you want to delete this testimonial from <strong>{{
                    testimonial.patient_name }}</strong>?</p>
            <div class="flex justify-center items-center px-4 py-3 mt-4">
                <form action="{{ url_for('delete_testimonial', testimonial_id=testimonial.id) }}" method="POST">
                    <button type="button" onclick="closeModal('deleteModal-{{ testimonial.id }}')"
                        class="bg-gray-500 text-white px-4 py-2 rounded font-bold hover:bg-gray-700 transition">Cancel</button>
                    <button type="submit"
                        class="bg-red-500 text-white px-4 py-2 rounded font-bold hover:bg-red-700 transition ml-2">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="editModal-{{ testimonial.id }}"
    class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
        <form action="{{ url_for('edit_testimonial', testimonial_id=testimonial.id) }}" method="POST">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Edit Testimonial</h3>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Patient Name <span
                        class="text-red-500">*</span></label>
                <input type="text" name="patient_name"
                    class="w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    value="{{ testimonial.patient_name }}" required>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Content / Review <span
                        class="text-red-500">*</span></label>
                <textarea name="content" rows="5"
                    class="w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required>{{ testimonial.content }}</textarea>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">YouTube Video URL (Optional)</label>
                <input type="text" name="youtube_link"
                    class="w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    value="{{ testimonial.youtube_link or '' }}"
                    placeholder="e.g., https://www.youtube.com/watch?v=...">
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Primary Doctor (Mandatory) <span
                        class="text-red-500">*</span></label>
                <select name="doctor1_id"
                    class="w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required>
                    <option value="" disabled>-- Select a Doctor --</option>
                    {% for doctor in doctors %}
                    <option value="{{ doctor.id }}" {% if testimonial.doctor_id==doctor.id %}selected{% endif %}>
                        {{ doctor.name }} - {{ doctor.specialization }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Secondary Doctor (Optional)</label>
                <select name="doctor2_id"
                    class="w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- None --</option>
                    {% for doctor in doctors %}
                    <option value="{{ doctor.id }}" {% if testimonial.doctor2_id==doctor.id %}selected{% endif %}>
                        {{ doctor.name }} - {{ doctor.specialization }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="flex justify-end items-center px-4 py-3 mt-4 border-t">
                <button type="button" onclick="closeModal('editModal-{{ testimonial.id }}')"
                    class="bg-gray-500 text-white px-4 py-2 rounded font-bold hover:bg-gray-700 transition">Cancel</button>
                <button type="submit"
                    class="bg-blue-500 text-white px-4 py-2 rounded font-bold hover:bg-blue-700 transition ml-2">Save
                    Changes</button>
            </div>
        </form>
    </div>
</div>
{% endfor %}

<script>
    function openModal(modalId) {
        document.getElementById(modalId).classList.remove('hidden');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
    }

    // REMOVED openImageModal function
</script>
{% endblock %}