{% extends "admin_layout.html" %}

{% block title %}
Manage Doctors - Admin Panel
{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    .draggable {
        cursor: move;
        transition: all 0.3s ease;
    }
    
    .draggable.dragging {
        opacity: 0.5;
        background-color: #f8f9fa;
    }
    
    .drag-handle {
        cursor: move;
        color: #6c757d;
        padding: 0 10px;
    }
    
    .table tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.03);
    }
    
    .sortable-ghost {
        opacity: 0.4;
        background-color: #e9ecef;
    }
    
    .sortable-chosen {
        background-color: #f8f9fa;
    }
    
    .auto-saving {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        display: none;
    }
</style>

<div class="container py-4">
    <h2 class="mb-4">Manage Doctors</h2>
    <div class="d-flex justify-content-end mb-3">
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
            Back to Dashboard
        </a>
    </div>

    <!-- Auto-saving notification -->
    <div class="auto-saving" id="autoSavingNotification">
        <i class="fas fa-check-circle"></i> Order saved successfully!
    </div>

    <form method="POST" enctype="multipart/form-data" class="mb-4 p-3 border rounded">
        <!-- Your existing form content remains exactly the same -->
        <h4 class="mb-3">Add New Doctor</h4>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Doctor Name *</label>
                <input type="text" name="name" class="form-control" required>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Specialization *</label>
                <input type="text" name="specialization" class="form-control" required>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Department *</label>
                <select name="department_slug" class="form-select" required>
                    <option value="">Select Department</option>
                    {% for dept in departments %}
                    <option value="{{ dept.slug }}">{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Designation</label>
                <input type="text" name="designation" class="form-control">
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Experience</label>
                <input type="text" name="experience" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Languages</label>
                <input type="text" name="languages" class="form-control">
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Bio</label>
            <textarea name="bio" class="form-control" rows="2"></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Qualification</label>
            <input type="text" name="qualification" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Overview</label>
            <textarea name="overview" class="form-control" rows="2"></textarea>
        </div>

        <div class="mb-3 p-3 border rounded">
            <h5>Fellowship / Membership</h5>
            <div class="mb-3">
                <label class="form-label">Details</label>
                <textarea name="fellowship_membership" class="form-control" rows="2"></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">Links (one per line)</label>
                <textarea name="fellowship_links" class="form-control" rows="2"
                    placeholder="https://example.com/link1&#10;https://example.com/link2"></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">Upload File</label>
                <input type="file" name="fellowship_file" class="form-control" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                <small class="form-text text-muted">Accepted formats: PDF, DOC, DOCX, JPG, PNG</small>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Field of Expertise</label>
            <textarea name="field_of_expertise" class="form-control" rows="2"></textarea>
        </div>

        <div class="mb-3 p-3 border rounded">
            <h5>Talks & Publications</h5>
            <div class="mb-3">
                <label class="form-label">Details</label>
                <textarea name="talks_and_publications" class="form-control" rows="2"></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">Links (one per line)</label>
                <textarea name="talks_links" class="form-control" rows="2"
                    placeholder="https://example.com/link1&#10;https://example.com/link2"></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">Upload File</label>
                <input type="file" name="talks_file" class="form-control" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                <small class="form-text text-muted">Accepted formats: PDF, DOC, DOCX, JPG, PNG</small>
            </div>
        </div>

        <div class="mb-3 p-3 border rounded">
            <h5>Doctor Availability</h5>
            <div id="timingsContainer">
                <div class="timing-entry border p-3 mb-2 rounded" data-index="0">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Time Slot 1</h6>
                        <button type="button" class="btn btn-sm btn-danger remove-timing" style="display:none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <label class="form-label d-block">Select Days *</label>
                    <div class="d-flex flex-wrap mb-2 days-container">
                        <div class="form-check me-2">
                            <input class="form-check-input" type="checkbox" name="days[0][]" value="MON" id="mon0">
                            <label class="form-check-label" for="mon0">Mon</label>
                        </div>
                        <div class="form-check me-2">
                            <input class="form-check-input" type="checkbox" name="days[0][]" value="TUE" id="tue0">
                            <label class="form-check-label" for="tue0">Tue</label>
                        </div>
                        <div class="form-check me-2">
                            <input class="form-check-input" type="checkbox" name="days[0][]" value="WED" id="wed0">
                            <label class="form-check-label" for="wed0">Wed</label>
                        </div>
                        <div class="form-check me-2">
                            <input class="form-check-input" type="checkbox" name="days[0][]" value="THU" id="thu0">
                            <label class="form-check-label" for="thu0">Thu</label>
                        </div>
                        <div class="form-check me-2">
                            <input class="form-check-input" type="checkbox" name="days[0][]" value="FRI" id="fri0">
                            <label class="form-check-label" for="fri0">Fri</label>
                        </div>
                        <div class="form-check me-2">
                            <input class="form-check-input" type="checkbox" name="days[0][]" value="SAT" id="sat0">
                            <label class="form-check-label" for="sat0">Sat</label>
                        </div>
                        <div class="form-check me-2">
                            <input class="form-check-input" type="checkbox" name="days[0][]" value="SUN" id="sun0">
                            <label class="form-check-label" for="sun0">Sun</label>
                        </div>
                    </div>

                    <div class="row mb-2 time-container">
                        <div class="col-md-6">
                            <label class="form-label">From</label>
                            <div class="input-group">
                                <input type="time" name="time_from[]" class="form-control">
                                <select name="time_from_period[]" class="form-select" style="max-width:90px">
                                    <option value="AM">AM</option>
                                    <option value="PM">PM</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">To</label>
                            <div class="input-group">
                                <input type="time" name="time_to[]" class="form-control">
                                <select name="time_to_period[]" class="form-select" style="max-width:90px">
                                    <option value="AM">AM</option>
                                    <option value="PM">PM</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button type="button" class="btn btn-outline-primary btn-sm" id="addTimingBtn">+ Add More</button>
        </div>

        <div class="mb-3">
            <label class="form-label">Appointment Link</label>
            <input type="url" name="appointment_link" class="form-control"
                placeholder="https://example.com/appointment">
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">Slug (optional)</label>
                <input type="text" name="slug" class="form-control">
            </div>
            <div class="col-md-6">
                <label class="form-label">Doctor Image</label>
                <input type="file" name="image" class="form-control" accept="image/*">
            </div>
        </div>

        <button type="submit" class="btn btn-success">Add Doctor</button>
    </form>

    <div class="mb-3">
        <input type="text" id="doctorSearch" class="form-control" placeholder="Search doctors by name...">
    </div>

    <h3 class="mt-5">Existing Doctors</h3>
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> Drag and drop doctors to reorder them. Changes are saved automatically.
    </div>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th style="width: 40px;">Order</th>
                    <th>Name</th>
                    <th>Specialization</th>
                    <th>Department</th>
                    <th>Image</th>
                    <th>Files</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="doctorsTableBody">
                {% for doctor in doctors %}
                <tr class="draggable" data-id="{{ doctor.id }}" data-order="{{ doctor.display_order or loop.index }}">
                    <td class="drag-handle">
                        <i class="fas fa-grip-vertical"></i>
                    </td>
                    <td>{{ doctor.name }}</td>
                    <td>{{ doctor.specialization }}</td>
                    <td>{{ doctor.department_slug }}</td>
                    <td>
                        {% if doctor.image_path %}
                        <img src="{{ url_for('static', filename=doctor.image_path) }}" alt="{{ doctor.name }}"
                            width="80" height="80" style="object-fit: cover;">
                        {% else %}
                        <span class="text-muted">No image</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if doctor.fellowship_file_path %}
                        <a href="{{ url_for('static', filename=doctor.fellowship_file_path) }}" target="_blank"
                            class="btn btn-sm btn-info mb-1">
                            Fellowship File
                        </a><br>
                        {% endif %}
                        {% if doctor.talks_file_path %}
                        <a href="{{ url_for('static', filename=doctor.talks_file_path) }}" target="_blank"
                            class="btn btn-sm btn-info">
                            Talks File
                        </a>
                        {% endif %}
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-primary editDoctorBtn" 
                            data-id="{{ doctor.id }}"
                            data-name="{{ doctor.name }}" 
                            data-specialization="{{ doctor.specialization }}"
                            data-department="{{ doctor.department_slug }}" 
                            data-designation="{{ doctor.designation }}"
                            data-experience="{{ doctor.experience }}" 
                            data-languages="{{ doctor.languages }}"
                            data-bio="{{ doctor.bio }}" 
                            data-qualification="{{ doctor.qualification }}"
                            data-overview="{{ doctor.overview }}"
                            data-fellowship_membership="{{ doctor.fellowship_membership }}"
                            data-fellowship_links="{{ doctor.fellowship_links }}"
                            data-fellowship_file="{{ doctor.fellowship_file_path }}"
                            data-field_of_expertise="{{ doctor.field_of_expertise }}"
                            data-talks_and_publications="{{ doctor.talks_and_publications }}"
                            data-talks_links="{{ doctor.talks_links }}" 
                            data-talks_file="{{ doctor.talks_file_path }}"
                            data-slug="{{ doctor.slug }}" 
                            data-image="{{ doctor.image_path }}"
                            data-appointment_link="{{ doctor.appointment_link }}"
                            data-timings="{{ doctor.timings | tojson | safe }}">
                            Edit
                        </button>
                        <form method="POST" action="{{ url_for('delete_doctor', doctor_id=doctor.id) }}"
                            style="display:inline;"
                            onsubmit="return confirm('Are you sure you want to delete this doctor?');">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="text-center">No doctors found. Add your first doctor above.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Edit Doctor Modal -->
    <div class="modal fade" id="doctorModal" tabindex="-1" aria-labelledby="doctorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form method="POST" enctype="multipart/form-data" id="doctorForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="doctorModalLabel">Edit Doctor</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" style="max-height:70vh; overflow-y:auto;">
                        <input type="hidden" name="doctor_id" id="doctor_id">

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Doctor Name *</label>
                                <input type="text" name="name" class="form-control" id="doctor_name" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Specialization *</label>
                                <input type="text" name="specialization" class="form-control" id="doctor_specialization" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Department *</label>
                                <select name="department_slug" class="form-select" id="doctor_department" required>
                                    <option value="">Select Department</option>
                                    {% for dept in departments %}
                                    <option value="{{ dept.slug }}">{{ dept.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Designation</label>
                                <input type="text" name="designation" class="form-control" id="doctor_designation">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Experience</label>
                                <input type="text" name="experience" class="form-control" id="doctor_experience">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Languages</label>
                                <input type="text" name="languages" class="form-control" id="doctor_languages">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Bio</label>
                            <textarea name="bio" class="form-control" rows="2" id="doctor_bio"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Qualification</label>
                            <input type="text" name="qualification" class="form-control" id="doctor_qualification">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Overview</label>
                            <textarea name="overview" class="form-control" rows="2" id="doctor_overview"></textarea>
                        </div>

                        <div class="mb-3 p-3 border rounded">
                            <h5>Fellowship / Membership</h5>
                            <div class="mb-3">
                                <label class="form-label">Details</label>
                                <textarea name="fellowship_membership" class="form-control" rows="2" id="doctor_fellowship_membership"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Links (one per line)</label>
                                <textarea name="fellowship_links" class="form-control" rows="2" id="doctor_fellowship_links"
                                    placeholder="https://example.com/link1&#10;https://example.com/link2"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Upload File</label>
                                <input type="file" name="fellowship_file" class="form-control" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                <div id="currentFellowshipFile" class="mt-2"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Field of Expertise</label>
                            <textarea name="field_of_expertise" class="form-control" rows="2" id="doctor_field_of_expertise"></textarea>
                        </div>

                        <div class="mb-3 p-3 border rounded">
                            <h5>Talks & Publications</h5>
                            <div class="mb-3">
                                <label class="form-label">Details</label>
                                <textarea name="talks_and_publications" class="form-control" rows="2" id="doctor_talks_and_publications"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Links (one per line)</label>
                                <textarea name="talks_links" class="form-control" rows="2" id="doctor_talks_links"
                                    placeholder="https://example.com/link1&#10;https://example.com/link2"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Upload File</label>
                                <input type="file" name="talks_file" class="form-control" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                <div id="currentTalksFile" class="mt-2"></div>
                            </div>
                        </div>

                        <div class="mb-3 p-3 border rounded">
                            <h5>Doctor Availability</h5>
                            <div id="modalTimingsContainer">
                                <!-- Timing entries will be dynamically added here -->
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="modalAddTimingBtn">+ Add More</button>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Appointment Link</label>
                            <input type="url" name="appointment_link" class="form-control" id="doctor_appointment_link">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Slug</label>
                            <input type="text" name="slug" class="form-control" id="doctor_slug">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Doctor Image</label>
                            <input type="file" name="image" class="form-control" accept="image/*">
                            <div id="currentImagePreview" class="mt-2"></div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    // Initialize drag and drop functionality
    document.addEventListener('DOMContentLoaded', function() {
        const doctorsTableBody = document.getElementById('doctorsTableBody');
        const autoSavingNotification = document.getElementById('autoSavingNotification');
        
        // Initialize Sortable for drag and drop with auto-save
        const sortable = Sortable.create(doctorsTableBody, {
            handle: '.draggable', // Changed from '.drag-handle' to '.draggable' to allow dragging from anywhere on the row
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            animation: 150,
            onStart: function() {
                // Add dragging class when drag starts
                document.querySelectorAll('.draggable').forEach(row => {
                    if (row !== sortable.draggedElement) {
                        row.classList.add('dragging');
                    }
                });
            },
            onEnd: function() {
                // Remove dragging class when drag ends
                document.querySelectorAll('.draggable').forEach(row => {
                    row.classList.remove('dragging');
                });
            },
            onUpdate: function() {
                // Auto-save when order changes
                saveDoctorOrder();
            }
        });
        
        // Function to save the new doctor order automatically
        function saveDoctorOrder() {
            const rows = document.querySelectorAll('#doctorsTableBody tr.draggable');
            const orderData = [];
            
            rows.forEach((row, index) => {
                const doctorId = row.getAttribute('data-id');
                orderData.push({
                    id: doctorId,
                    display_order: index + 1
                });
            });
            
            // Show saving notification
            showAutoSaveNotification('Saving order...', 'info');
            
            // Send AJAX request to update order
            fetch('/admin/doctors/update-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ order: orderData })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Show success notification
                    showAutoSaveNotification('Order saved successfully!', 'success');
                    
                    // Update data-order attributes
                    const rows = document.querySelectorAll('#doctorsTableBody tr.draggable');
                    rows.forEach((row, index) => {
                        row.setAttribute('data-order', index + 1);
                    });
                } else {
                    console.error('Error updating doctor order:', data.message);
                    showAutoSaveNotification('Error saving order: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAutoSaveNotification('Error saving order. Please try again.', 'danger');
            });
        }
        
        // Function to show auto-save notification
        function showAutoSaveNotification(message, type = 'success') {
            const notification = document.getElementById('autoSavingNotification');
            
            // Update message and style based on type
            notification.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'info' ? 'fa-sync fa-spin' : 'fa-exclamation-circle'}"></i> ${message}`;
            notification.style.background = type === 'success' ? '#28a745' : type === 'info' ? '#17a2b8' : '#dc3545';
            notification.style.display = 'block';
            
            // Auto-hide after 3 seconds for success, stay visible for errors
            if (type !== 'danger') {
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        }

        // Main form timing functionality
        document.getElementById("addTimingBtn").addEventListener("click", function () {
            addTimingEntry("timingsContainer", false);
        });

        // Modal timing functionality
        document.getElementById("modalAddTimingBtn").addEventListener("click", function () {
            addTimingEntry("modalTimingsContainer", true);
        });

        // Function to add timing entry
        function addTimingEntry(containerId, isModal = false) {
            const container = document.getElementById(containerId);
            const entries = container.querySelectorAll(".timing-entry");
            const newIndex = entries.length;
            
            // Clone the first entry
            const newEntry = entries[0].cloneNode(true);
            newEntry.setAttribute("data-index", newIndex);

            // Reset all values
            newEntry.querySelectorAll("input[type='checkbox']").forEach(cb => cb.checked = false);
            newEntry.querySelectorAll("input[type='time']").forEach(input => input.value = "");
            newEntry.querySelectorAll("select").forEach(select => select.value = "AM");

            // Update names and IDs
            newEntry.querySelectorAll("input, select").forEach(el => {
                if (el.name) {
                    el.name = el.name.replace(/\[\d+\]/, `[${newIndex}]`);
                }
                if (el.id) {
                    const prefix = isModal ? "modal_" : "";
                    const baseId = el.id.replace(/[0-9]/g, '');
                    el.id = prefix + baseId + newIndex;
                }
            });

            // Update labels
            newEntry.querySelectorAll("label").forEach(label => {
                const htmlFor = label.getAttribute("for");
                if (htmlFor) {
                    const prefix = isModal ? "modal_" : "";
                    const baseFor = htmlFor.replace(/[0-9]/g, '');
                    label.setAttribute("for", prefix + baseFor + newIndex);
                }
            });

            // Update title
            const title = newEntry.querySelector("h6");
            if (title) {
                title.textContent = `Time Slot ${newIndex + 1}`;
            }

            // Show remove button
            const removeBtn = newEntry.querySelector(".remove-timing");
            if (removeBtn) {
                removeBtn.style.display = 'block';
                removeBtn.onclick = function() {
                    if (container.querySelectorAll(".timing-entry").length > 1) {
                        newEntry.remove();
                        reindexTimingEntries(containerId, isModal);
                    }
                };
            }

            container.appendChild(newEntry);
        }

        // Function to reindex timing entries after removal
        function reindexTimingEntries(containerId, isModal = false) {
            const container = document.getElementById(containerId);
            const entries = container.querySelectorAll(".timing-entry");
            
            entries.forEach((entry, index) => {
                entry.setAttribute("data-index", index);
                
                // Update names
                entry.querySelectorAll("input, select").forEach(el => {
                    if (el.name) {
                        el.name = el.name.replace(/\[\d+\]/, `[${index}]`);
                    }
                });
                
                // Update IDs and labels
                entry.querySelectorAll("input, select, label").forEach(el => {
                    if (el.id || el.getAttribute("for")) {
                        const prefix = isModal ? "modal_" : "";
                        const oldId = el.id || el.getAttribute("for");
                        const baseId = oldId.replace(/(modal_)?[a-z]+/i, '').replace(/\d+$/, '');
                        const newId = prefix + baseId + index;
                        
                        if (el.id) el.id = newId;
                        if (el.getAttribute("for")) el.setAttribute("for", newId);
                    }
                });

                // Update title
                const title = entry.querySelector("h6");
                if (title) {
                    title.textContent = `Time Slot ${index + 1}`;
                }
            });
        }

        // Function to populate timing entries in modal
        function populateTimingEntries(timingsData) {
            const modalTimingsContainer = document.getElementById('modalTimingsContainer');
            modalTimingsContainer.innerHTML = '';

            if (!timingsData || timingsData.length === 0) {
                // Add one empty entry if no timings
                const template = document.querySelector("#timingsContainer .timing-entry").cloneNode(true);
                modalTimingsContainer.appendChild(template);
                return;
            }

            // Create entries for each timing
            timingsData.forEach((timing, index) => {
                const template = document.querySelector("#timingsContainer .timing-entry").cloneNode(true);
                
                // Set days
                if (timing.days && Array.isArray(timing.days)) {
                    timing.days.forEach(day => {
                        const checkbox = template.querySelector(`input[value="${day}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                // Set time values
                if (timing.from) {
                    template.querySelector('input[name="time_from[]"]').value = timing.from;
                }
                if (timing.from_period) {
                    template.querySelector('select[name="time_from_period[]"]').value = timing.from_period;
                }
                if (timing.to) {
                    template.querySelector('input[name="time_to[]"]').value = timing.to;
                }
                if (timing.to_period) {
                    template.querySelector('select[name="time_to_period[]"]').value = timing.to_period;
                }

                // Update names and IDs for modal
                template.querySelectorAll("input, select").forEach(el => {
                    if (el.name) {
                        el.name = el.name.replace(/\[\d+\]/, `[${index}]`);
                    }
                    if (el.id) {
                        el.id = "modal_" + el.id + index;
                    }
                });

                template.querySelectorAll("label").forEach(label => {
                    const htmlFor = label.getAttribute("for");
                    if (htmlFor) {
                        label.setAttribute("for", "modal_" + htmlFor + index);
                    }
                });

                // Update title
                const title = template.querySelector("h6");
                if (title) {
                    title.textContent = `Time Slot ${index + 1}`;
                }

                // Add remove button
                const removeBtn = template.querySelector(".remove-timing");
                if (removeBtn) {
                    removeBtn.style.display = 'block';
                    removeBtn.onclick = function() {
                        if (modalTimingsContainer.querySelectorAll(".timing-entry").length > 1) {
                            template.remove();
                            reindexTimingEntries("modalTimingsContainer", true);
                        }
                    };
                }

                modalTimingsContainer.appendChild(template);
            });
        }

        // Edit doctor modal functionality
        const editButtons = document.querySelectorAll('.editDoctorBtn');
        const doctorModal = new bootstrap.Modal(document.getElementById('doctorModal'));
        
        editButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                // Set form action
                document.getElementById('doctorForm').action = `/admin/doctors/edit/${btn.dataset.id}`;
                document.getElementById('doctor_id').value = btn.dataset.id;
                
                // Fill basic information
                document.getElementById('doctor_name').value = btn.dataset.name || '';
                document.getElementById('doctor_specialization').value = btn.dataset.specialization || '';
                document.getElementById('doctor_department').value = btn.dataset.department || '';
                document.getElementById('doctor_designation').value = btn.dataset.designation || '';
                document.getElementById('doctor_experience').value = btn.dataset.experience || '';
                document.getElementById('doctor_languages').value = btn.dataset.languages || '';
                document.getElementById('doctor_bio').value = btn.dataset.bio || '';
                document.getElementById('doctor_qualification').value = btn.dataset.qualification || '';
                document.getElementById('doctor_overview').value = btn.dataset.overview || '';
                document.getElementById('doctor_fellowship_membership').value = btn.dataset.fellowship_membership || '';
                document.getElementById('doctor_fellowship_links').value = btn.dataset.fellowship_links || '';
                document.getElementById('doctor_field_of_expertise').value = btn.dataset.field_of_expertise || '';
                document.getElementById('doctor_talks_and_publications').value = btn.dataset.talks_and_publications || '';
                document.getElementById('doctor_talks_links').value = btn.dataset.talks_links || '';
                document.getElementById('doctor_slug').value = btn.dataset.slug || '';
                document.getElementById('doctor_appointment_link').value = btn.dataset.appointment_link || '';

                // Parse and populate timing data
                try {
                    const timingsData = JSON.parse(btn.dataset.timings || '[]');
                    populateTimingEntries(timingsData);
                } catch (e) {
                    console.error('Error parsing timings data:', e);
                    populateTimingEntries([]);
                }

                // Set up file previews
                const preview = document.getElementById('currentImagePreview');
                preview.innerHTML = btn.dataset.image ? 
                    `<img src="/static/${btn.dataset.image}" width="100" height="100" style="object-fit: cover;" class="mb-2"><br>
                     <small class="text-muted">Current image</small>` : 
                    '<small class="text-muted">No image</small>';

                const fellowshipPreview = document.getElementById('currentFellowshipFile');
                fellowshipPreview.innerHTML = btn.dataset.fellowship_file ? 
                    `<p class="mb-1">Current file: <a href="/static/${btn.dataset.fellowship_file}" target="_blank">View File</a></p>
                     <div class="form-check">
                         <input class="form-check-input" type="checkbox" name="remove_fellowship_file" id="remove_fellowship_file">
                         <label class="form-check-label" for="remove_fellowship_file">Remove current file</label>
                     </div>` : 
                    '';

                const talksPreview = document.getElementById('currentTalksFile');
                talksPreview.innerHTML = btn.dataset.talks_file ? 
                    `<p class="mb-1">Current file: <a href="/static/${btn.dataset.talks_file}" target="_blank">View File</a></p>
                     <div class="form-check">
                         <input class="form-check-input" type="checkbox" name="remove_talks_file" id="remove_talks_file">
                         <label class="form-check-label" for="remove_talks_file">Remove current file</label>
                     </div>` : 
                    '';

                doctorModal.show();
            });
        });

        // Search functionality
        const doctorSearchInput = document.getElementById('doctorSearch');
        const doctorsRows = document.querySelector('table tbody').getElementsByTagName('tr');
        
        doctorSearchInput.addEventListener('keyup', function () {
            const filter = this.value.toLowerCase();
            for (let row of doctorsRows) {
                const nameCell = row.getElementsByTagName('td')[1]; // Changed to index 1 because we added order column
                if (nameCell) {
                    const nameText = nameCell.textContent || nameCell.innerText;
                    row.style.display = nameText.toLowerCase().indexOf(filter) > -1 ? "" : "none";
                }
            }
        });

        // Initialize remove buttons for main form
        const mainTimingsContainer = document.getElementById('timingsContainer');
        const entries = mainTimingsContainer.querySelectorAll(".timing-entry");
        if (entries.length > 1) {
            entries.forEach((entry, index) => {
                if (index > 0) {
                    const removeBtn = entry.querySelector(".remove-timing");
                    if (removeBtn) {
                        removeBtn.style.display = 'block';
                        removeBtn.onclick = function() {
                            if (mainTimingsContainer.querySelectorAll(".timing-entry").length > 1) {
                                entry.remove();
                                reindexTimingEntries("timingsContainer", false);
                            }
                        };
                    }
                }
            });
        }
    });
</script>
{% endblock %}